<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale solid #333; margin-bottom: 10px; background: rgba(0,0,0,0.5); }
        .room-item { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; cursor: pointer; font-size: 0=1.0, user-scalable=no">
    <title>NEURAL_LINK // V17.1_PATCHED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three..9rem; }
        #terminal { position: absolute; inset: 0; z-index: 50; background: rgba(5,5,5,0.95); visibility: hidden; display:js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans flex; flex-direction: column; }
        header { padding: 8px 15px; border+SC:wght@400;700&family=ZCOOL+QingKe+HuangYou&display=swap');
        :root { --bg-color: #050505; --neon-cyan: #00f3ff; --neon-pink: #ff0055; --neon-yellow: #fcee0a; --font-title: 'ZCOOL QingKe HuangYou', cursive; --font-body: 'Noto Sans SC', sans-serif; }
        * { box-sizing: border-box;-bottom: 1px solid var(--neon-cyan); background: #111; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .hud-val { color: var(--neon-cyan); font-weight: bold; margin-left: 5px; }
        .hud-val.secret { color: var(--neon-pink); }
        #visual-container { height: 30vh; overflow: hidden; position: relative; border-bottom: 1px solid #333; flex-shrink: 0; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.5s; }
        .overlay-ui { position: absolute; top: 10px; left: 10px; z-index: 10; background: user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: rgba(0,0,0,0.6); padding: 4px 8px; font-size 0; background: var(--bg-color); color: #eee; font-family: var(--font-: 0.8rem; color: #fff; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; gap: 15px; }
        .msg-block { padding-left: 12px; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .v border-left: 3px solid #333; opacity: 0; transform: translateY(10px);ignette { position: fixed; inset: 0; z-index: 1; background: radial-gradient transition: 0.5s; font-size: 1rem; line-height: 1.6(circle, transparent 40%, #000 100%); pointer-events: none; }; color: #ddd; }
        .msg-block.show { opacity: 1; transform: translateY
        .scanlines { position: fixed; inset: 0; z-index: 2; background:(0); }
        #controls-area { padding: 15px; background: #111 linear-gradient(to bottom, rgba(255,255,255,0), rgba; border-top: 1px solid #333; position: relative; }
        #next-(255,255,255,0) 50%, rgba(0,0,0,0.trigger { text-align: center; padding: 15px; color: #888; cursor:1) 50%, rgba(0,0,0,0.1)); background-size: 1 pointer; border-bottom: 1px solid #333; margin-bottom: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.00% 4px; pointer-events: none; }
        .hidden { display: none !important; }
        .cyber-btn { background: rgba(0, 20, 40, 5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; opacity: 0.3; pointer-events: none; transition0.9); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 12px; font-family: var(--font-title); font-size: 1.1rem; width: 100%; margin-bottom: 10px; cursor: pointer; text: 0.3s; }
        #controls.active { opacity: 1; pointer-events:-transform: uppercase; letter-spacing: 1px; }
        .cyber-btn:active { background: var(--neon-cyan); color: #000; }
        #modal { position: absolute; inset: 0; z-index: 100; display: flex; flex-direction: column; all; }
        #wait-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 20; display: flex; justify-content: center; align-items: justify-content: center; align-items: center; background: rgba(0,0,0,0. center; color: var(--neon-cyan); font-family: var(--font-title); }
        #intro-layer { position: fixed; inset: 0; z-index: 2000; background95); padding: 20px; }
        textarea { background: #111; border:: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--neon-cyan); font-family: var(--font-title); font-size: 1.5rem; transition: 1s; }
        .intro-text { font- 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 10px; width: 100%; margin-bottom: 10px; }
        .id-card { border: 1px solid var(--neon-pink); padding: 15px; margin-bottom:size: 1.8rem; text-shadow: 0 0 10px var(--neon- 20px; background: rgba(20, 0, 10, 0.8);cyan); margin-bottom: 30px; text-align: center; padding: 20px; width: 100%; max-width: 300px; text-align: left; }
        .id-row { display: flex; justify-content: space-between; margin-bottom:  opacity: 0; transition: 0.5s; }
        .door-frame { position: absolute; width: 80px; height: 160px; border: 2px solid #fff5px; font-size: 0.9rem; }
        .id-val { color: #; box-shadow: 0 0 50px #fff; opacity: 0; transition: 2s; }
        .zoom-effect { animation: zoomIn 2.5s forwards ease-in; }
        @keyframes zoomIn { 0% { transform: scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: scale(60); opacity: 0; } }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<!-- CONFIG & LOBBY -->
<div id="modal">
    <h1 style="color:var(--neon-cyan); font-family:var(--font-title); font-size:2.5rem; margin-bottom:10px">NEURAL LINK</h1>
    
    <div id="step-config">
        <textarea id="config-input" placeholder="粘贴 Firebase Config..." style="height:60px"></textarea>
        <button class="cyber-btn" onclick="initApp()">初始化 (INIT)</button>
    </div>

    <div idfff; font-weight: bold; }
        #room-list-container { width: 100%; max-width: 400px; height: 150px; overflow-y: auto; border: 1px solid #333; margin-bottom: 10px; background: rgba(0,0,0,0.5); }
        .room-item { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; cursor: pointer; font-size: 0.9rem; }
        .room-item:hover { background: rgba(0, 243, 255, 0.1); }
        #terminal { position: absolute; inset: 0; z-index: 50; background: rgba(5,5,5,0.95); visibility: hidden; display: flex; flex-direction: column; }
        header { padding: 8px 15px; border-bottom: 1px solid var(--neon-cyan); background: #111; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .hud-val { color: var(--neon-cyan); font-weight: bold; margin-left: 5="step-lobby" class="hidden" style="width:100%; max-width:400px; text-align:center">
        <div class="id-card">
            <div class="id-row"><span class="id-val" id="card-name">...</span> <span class="id-val" id="card-role" style="color:var(--neon-yellow)">...</span></div>
            px; }
        .hud-val.secret { color: var(--neon-pink); }
        #visual-container { height: 30vh; overflow: hidden; position: relative; border-bottom: 1px solid #333; flex-shrink: 0; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0;<div class="id-row" style="border-top:1px dashed #444; margin- transition: 0.5s; }
        .overlay-ui { position: absolute; top: 1top:5px; padding-top:5px">
                <span style="color:#888">0px; left: 10px; z-index: 10; background: rgba(0,0,0,0.6); padding: 4px 8px; font-size: 0.8rem; color: #fff; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        绝密:</span> <span id="card-secret" style="color:var(--neon-pink)">...</span>
            </div>
        </div>
        <div id="room-list-container"><div style="padding:20px; color:#444">正在扫描...</div></div>
        <button class="cyber-btn" onclick="createSolo.msg-block { padding-left: 12px; border-left: 3px solid #3Game()">开启单人位面</button>
        <div style="display:flex; gap:1033; opacity: 0; transform: translateY(10px); transition: 0.5s;px">
            <input id="room-input" placeholder="位面ID" style="margin:0">
            <button class="cyber-btn" style="width:auto; margin:0" onclick="joinGame()">加入</button>
        </div>
        <div style="margin-top:10px; font- font-size: 1rem; line-height: 1.6; color: #ddd; }
        .msg-block.show { opacity: 1; transform: translateY(0); }
        #controls-area { padding: 15px; background: #111; border-top: 1pxsize:0.8rem; color:#444; cursor:pointer" onclick="deleteCharacter()">[重 solid #333; position: relative; }
        #next-trigger { text-align: center;置身份]</div>
    </div>
    
    <div id="step-waiting" class="hidden" style padding: 15px; color: #888; cursor: pointer; border-bottom: 1="text-align:center">
        <h2 id="room-code-disp" style="color:px solid #333; margin-bottom: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% {var(--neon-yellow)">...</h2>
        <p style="color:#888">等待接入...</p>
        <div id="player-count" style="color:var(--neon-cyan); margin:2 opacity: 1; } 100% { opacity: 0.5; } }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 100px">连接数: 1</div>
        <button class="cyber-btn" onclick="firstStart()">启动 (START)</button>
    </div>
</div>

<!-- INTRO -->
<div id="intro-layer" class="hidden">
    <div id="intro-content" class="intro-text"></div>
    <div id="the-door" class="door-frame"></div>
</div>

<!-- GAME -->
<divpx; opacity: 0.3; pointer-events: none; transition: 0.3s; }
        #controls.active { opacity: 1; pointer-events: all; }
        #wait-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 20; display: flex; justify-content: center; align-items: center; color: var(--neon-cyan); font-family: var(--font-title); }
        #intro-layer { position: fixed; id="terminal">
    <header>
        <div>ROOM: <span id="hud-room">0000</span></div>
        <div>HP:<span id="hud-hp" class="hud-val">10 inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--neon-cyan); font-family: var(--font-title); font-size: 1.5rem; transition: 1s; }
        .intro-text { font-size: 1.8rem;0</span> ITEM:<span id="hud-item" class="hud-val secret">...</span></div>
    </header>
    <div id="visual-container">
        <img id="scene-img" src="">
        <div class="overlay-ui"><span>FEED: <span id="loading-hint">STANDBY</span></span></div>
    </div>
    <div id="content-scroll"><div id="story-box"></div></div>
    <div id="controls-area">
        <div id="wait-overlay" class="hidden"><p>等待决策同步...</p></div>
        <div id="next-trigger" onclick="advanceFragment()">▼ 点击继续剧情 ▼</div> text-shadow: 0 0 10px var(--neon-cyan); margin-bottom: 3
        <div id="controls">
            <button id="btn-a" class="cyber-btn"0px; text-align: center; padding: 20px; opacity: 0; transition:  onclick="makeChoice('A')">A</button>
            <button id="btn-b" class="0.5s; }
        .door-frame { position: absolute; width: 80px; height: 160px; border: 2px solid #fff; box-shadow: 0 0 50px #fff; opacity: 0; transition: 2s; }
        .zoom-effect { animation: zoomIn 2.5s forwards ease-in; }
        @keyframes zoomIncyber-btn" onclick="makeChoice('B')">B</button>
        </div>
    </div>
</div>

<script>
    let db, auth, user, myProfile = null;
    let currentRoomId = null;
    let currentData = null;
    let currentStage = 0;

    // 1. INIT
    function initApp() {
        const cfgStr = document.getElementById('config-input').value.trim();
        if(!cfgStr) return alert("Config Required");
        try {
            let clean = cfgStr.includes("=") ? cfgStr.substring(cfgStr.indexOf('{'), cfgStr.lastIndexOf('}')+1) : cfgStr;
            const config = new Function("return " + clean)();
            firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.database();
            auth.signInAnonymously().then(u => {
                user = u.user;
                loadCharacter();
                initParticles();
            });
        } catch(e) { alert("配置错误"); }
    }

    function loadCharacter() {
        db.ref('users/' + user.uid).once('value', s => {
            const val = s.val();
            if (val && val.profile) { myProfile = val.profile; renderLobby(); }
            else { createNewCharacter(); }
        });
    }

    function createNewCharacter() {
        const roles = [
            { id: "Solo", label: "街头佣兵", hp: 120, items: ["突击步枪"], secret: "被通缉" },
            { id: "Netrunner", label: "黑客", hp: 80, items: ["接入仓"], secret: "脑数据损坏" },
            { id: "Doc", label: "义体医生", hp { 0% { transform: scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: scale(60); opacity: 0; } }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<div id="modal">
    <h1 style="color:var(--neon-cyan); font-family:var(--font-title); font-size:2.5rem; margin-bottom:10px">NEURAL LINK</h1>
    <div id="step-config">
        <textarea id="config-input" placeholder="粘贴 Firebase Config..." style="height:60px"></textarea>
        <button class="cyber-btn" onclick="initApp()">初始化 (INIT)</button>
    </div>
    <div id="step-lobby" class="hidden" style="width:100%; max-width:400px; text-align:center">
        <div class="id-card">
            <div class="id-row"><span class="id-val: 90, items: ["急救针"], secret: "黑市交易" }
        ];
" id="card-name">...</span> <span class="id-val" id="card-role" style="color:var(--neon-yellow)">...</span></div>
            <div class="id-row" style="border-top:1px dashed #444; margin-top:5px; padding-top:5px">
                <span style="color:#888">绝密:</span> <span id="card-secret" style="color:var(--neon-pink)">...</span>
            </div>
        </div>
        <div id="room-list-container        const r = roles[Math.floor(Math.random() * roles.length)];
        const name = ["V", "强尼", "杰克", "露西", "K"][Math.floor(Math.random()*5)] + "_" + Math.floor(Math.random()*99);
        myProfile = { name: name, role: r.label, public: { hp: r.hp, weapon: r.items[0] }, private"></div>
        <button class="cyber-btn" onclick="createSoloGame()">开启单人位面</button>
        <div style="display:flex; gap:10px">
            <input id="room-input" placeholder="位面ID" style="margin:0">
            <button class="cyber-btn" style="width:auto; margin:0" onclick="joinGame()">加入</button>
        </div>: { secret: r.secret, hidden_items: r.items } };
        db.ref('users/' + user.uid).set({ profile: myProfile });
        renderLobby();
    }

    function renderLobby() {
        document.getElementById('card-name').innerText = myProfile.name;

        <div style="margin-top:10px; font-size:0.8rem; color:#444; cursor:pointer" onclick="deleteCharacter()">[重置身份]</div>
    </div>
    <div id="step-waiting" class="hidden" style="text-align:center">
        <h2 id="room-code-disp" style="color:var(--neon-yellow)">...</h2>
        <p style="color:#888">等待接入...</p>
        <div id="player-count        document.getElementById('card-role').innerText = myProfile.role;
        document.getElementById('card-secret').innerText = myProfile.private.secret;
        document.getElementById('step-config').classList.add('hidden');
        document.getElementById('step-lobby').classList.remove('hidden');
        db.ref('rooms').limitToLast(10).on('value', s => {
            const div = document." style="color:var(--neon-cyan); margin:20px">连接数: 1</div>
        <button class="cyber-btn" onclick="firstStart()">启动 (START)</button>
    </div>
getElementById('room-list-container');
            div.innerHTML = "";
            const rooms = s.val();
            if(rooms) {
                Object.keys(rooms).reverse().forEach(rid => {
                    </div>

<div id="intro-layer" class="hidden">
    <div id="intro-content" class="intro-text"></div>
    <div id="the-door" class="door-frame"></div>
</div>

<div id="terminal">
    <header>
        <div>ROOM: <span id="hud-room">0000</span></div>
        <div>HP:<span id="hud-hp" class="hud-val">100</span> ITEM:<span id="hud-item" class="hud-val secret">...</span></div>
    </header>
    <div id="visual-container">
        <img id="scene-img" src="">const r = rooms[rid];
                    if(!r.host_info) return;
                    const item = document.createElement('div');
                    item.className = 'room-item';
                    item.innerHTML = `<span style="color:var(--neon-cyan)">[${r.host_info.role}] ${r.host_info.name}</span> <span>${r.status}</span>`;
                    item.onclick = () => joinGame(rid);
                    div.appendChild(item);
                });
            }
        });
    }

    function deleteCharacter()
        <div class="overlay-ui"><span>FEED: <span id="loading-hint">STANDBY</span> { if(confirm("重置?")) db.ref('users/'+user.uid).remove().then(()=></span></div>
    </div>
    <div id="content-scroll"><div id="story-box"></div></div>location.reload()); }

    // 2. ACTIONS
    async function createSoloGame() {
        try {
            const res = await fetch('/api/game', { method: 'POST', headers: {'Content-
    <div id="controls-area">
        <div id="wait-overlay" class="hidden"><p>等待决策同步...</p></div>
        <div id="next-trigger" onclick="advanceFragment()">▼ 点击继续剧情 ▼</div>Type': 'application/json'}, body: JSON.stringify({ action: 'CREATE_ROOM', userProfile: myProfile }) });
            const data = await res.json();
            currentRoomId = data.roomId;

        <div id="controls">
            <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">A</button>
            <button id="btn-b" class="            await fetch('/api/game', { method: 'POST', headers: {'Content-Type': 'application/cyber-btn" onclick="makeChoice('B')">B</button>
        </div>
    </div>
</div>

<script>
    let db, auth, user, myProfile = null;
    let currentRoomId = null;
    let currentData = null;
    let currentStage = 0;

    function initApp() {
        json'}, body: JSON.stringify({ action: 'JOIN_ROOM', roomId: currentRoomId, userId: user.uid, userProfile: myProfile }) });
            document.getElementById('step-lobby').classList.add('const cfgStr = document.getElementById('config-input').value.trim();
        if(!cfgStr) returnhidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            document.getElementById(' alert("Config Required");
        try {
            let clean = cfgStr.includes("=") ? cfgStr.room-code-disp').innerText = currentRoomId;
            db.ref(`rooms/${currentRoomId}/substring(cfgStr.indexOf('{'), cfgStr.lastIndexOf('}')+1) : cfgStr;
            const config = new Function("return " + clean)();
            firebase.initializeApp(config);
            auth = firebaseplayers`).on('value', s => { document.getElementById('player-count').innerText = `连接数: ${s.numChildren()}`; });
        } catch(e) { alert(e.message); }
    .auth();
            db = firebase.database();
            auth.signInAnonymously().then(u =>}

    async function joinGame(rid) {
        const ridVal = rid || document.getElementById('room {
                user = u.user;
                loadCharacter();
                initParticles();
            });
        -input').value;
        try {
            const res = await fetch('/api/game', { method:} catch(e) { alert("配置错误"); }
    }

    function loadCharacter() {
        db.ref('users/' + user.uid).once('value', s => {
            const val = s.val();
            if (val && val.profile) { myProfile = val.profile; renderLobby 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'JOIN_ROOM', roomId: ridVal, userId: user.uid, userProfile: myProfile }) });
            if(res.ok) { currentRoomId = ridVal; startTransition(); } else alert("无法加入");
        } catch(e) { alert("ERR"); }
    }

    async function firstStart() {
        start(); }
            else { createNewCharacter(); }
        });
    }

    function createNewCharacter() {
        const roles = [
            { id: "Solo", label: "街头佣兵", hp: 120, itemsTransition();
        fetch('/api/game', { method: 'POST', headers: {'Content-Type': ': ["突击步枪"], secret: "被通缉" },
            { id: "Netrunner", label: "黑application/json'}, body: JSON.stringify({ action: 'START_GAME', roomId: currentRoomId, userId客", hp: 80, items: ["接入仓"], secret: "脑数据损坏" },
            : user.uid }) });
    }

    // 3. TRANSITION
    function startTransition() {
        document.getElementById('modal').style.display = 'none';
        playIntroSequence().then(() => {
            const term = document.getElementById('terminal');
            term.style.visibility = 'visible'; term.style{ id: "Doc", label: "义体医生", hp: 90, items: ["急救针"], secret: "黑市交易" }
        ];
        const prefixes = ["流浪", "荒坂", "军用", "街头", "夜之城"];
        const names = ["V", "强尼", "杰克", "露西", "K"];
        const r = roles[Math.floor(.opacity = 1;
            document.getElementById('hud-room').innerText = currentRoomId;
            document.getElementById('hud-hp').innerText = myProfile.public.hp;
            document.getElementById('hud-item').innerText = myProfile.private.hidden_items[0];

            db.ref(`rooms/${Math.random() * roles.length)];
        const name = prefixes[Math.floor(Math.random()*prefixes.length)] + "·" + names[Math.floor(Math.random()*names.length)];
currentRoomId}/current_scene`).on('value', snapshot => {
                const data = snapshot.val();        myProfile = { name: name, role: r.label, public: { hp: r.hp, weapon: r.items[0] }, private: { secret: r.secret, hidden_items: r.
                if(data) {
                    // ★★★ 核心修复：安全获取数据 ★★★
                    // 先尝试拿 user.uid 的数据，拿不到就拿 Object.values 的第一个（保底）
                    const myitems } };
        db.ref('users/' + user.uid).set({ profile: myProfile });
        renderLobby();
    }

    function renderLobby() {
        document.getElementById('card-name').innerText = myProfile.name;
        document.getElementById('card-role').innerText = myProfile.Data = data[user.uid] || Object.values(data)[0];
                    if (myData) renderScene(myData);
                }
            });
        });
    }

    // 4. RENDER
    function renderScene(data) {
        document.getElementById('wait-overlay').classList.add('hidden');
        currentData = data; currentStage = 0;
        document.getElementById('story-box').innerHTML = "";
        document.getElementById('role;
        document.getElementById('card-secret').innerText = myProfile.private.secret;
        document.getElementById('step-config').classList.add('hidden');
        document.getElementById('step-lobby').classList.remove('hidden');
        db.ref('rooms').limitToLast(10).on('value', s => {
            const div = document.getElementById('room-list-container');
            div.innerHTML = "";
            const rooms = s.val();
            if(rooms) {
                Object.keys(rooms).reverse().forEach(rid => {
                    const r = rooms[rid];
                    if(!r.host_info) return;
                    const item = document.createElement('div');
                    item.className = 'roomcontrols').classList.remove('active');
        document.getElementById('next-trigger').style.display = 'none';
        
        const rawKw = data.image_keyword || "city";
        const kw = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g,"");
        const url = `https://loremflickr.com/640/360/cyberpunk,${kw-item';
                    item.innerHTML = `<span style="color:var(--neon-cyan)">[${r}?random=${Date.now()}`;
        const img = document.getElementById('scene-img'); img.style.host_info.role}] ${r.host_info.name}</span> <span>${r.status}</span>`;
                    item.onclick = () => joinGame(rid);
                    div.appendChild(item);
.opacity=0; img.src=url;
        img.onload = () => { img.style.                });
            }
        });
    }

    function deleteCharacter() { if(confirm("重置opacity=0.8; document.getElementById('loading-hint').innerText = "LIVE"; };

        if (data.stage_1_env?")) db.ref('users/'+user.uid).remove().then(()=>location.reload()); }

    async function createSoloGame() {
        try {
            const res = await fetch('/api/game', {) {
            addMsg(data.stage_1_env, 'var(--neon-cyan)');
            setTimeout(() => { document. method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ actiongetElementById('next-trigger').style.display = 'block'; }, 1000);
        }
    }

    window.advanceFragment = function() {
        document.getElementById('next-trigger').style.: 'CREATE_ROOM', userProfile: myProfile }) });
            const data = await res.json();
display = 'none';
        if (currentStage === 0) {
            currentStage = 1;            currentRoomId = data.roomId;
            await fetch('/api/game', { method: 'POST',
            addMsg(currentData.stage_2_event, 'var(--neon-pink)');
            setTimeout(() => document.getElementById('next-trigger').style.display = 'block', 1000);
        } else if (currentStage === 1) {
            currentStage = 2;
            addMsg headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'JOIN_ROOM', roomId: currentRoomId, userId: user.uid, userProfile: myProfile }) });
            document.getElementById('step-lobby').classList.add('hidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            document.getElementById('room-code-disp').innerText = currentRoomId;
            db.ref(`rooms/${currentRoomId}/players`).on('value', s => { document.getElementById('player(currentData.stage_3_analysis, 'var(--neon-yellow)');
            document.getElementById('btn-a').innerText = `[A] ${currentData.choices[0].text}`;
            document.getElementById('btn-b').innerText = `[B] ${currentData.choices[1].text}`;
            document.getElementById('controls').classList.add('active');
            const b = document.getElementById('content-scroll');-count').innerText = `连接数: ${s.numChildren()}`; });
        } catch(e) { alert(e.message); }
    }

    async function joinGame(rid) {
        const ridVal = rid || document.getElementById('room-input').value;
        try {
            const res = await fetch('/api/game', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ b.scrollTop = b.scrollHeight;
        }
    }

    async function makeChoice(text) {
        document.getElementById('wait-overlay').classList.remove('hidden');
        const choiceText = (text === 'A') ? currentData.choices[0].text : currentData.choices[1].text;
 action: 'JOIN_ROOM', roomId: ridVal, userId: user.uid, userProfile: myProfile })        try {
            await fetch('/api/game', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'MAKE_MOVE', roomId: currentRoomId });
            if(res.ok) { currentRoomId = ridVal; startTransition(); } else alert(", userId: user.uid, choiceText: choiceText }) });
        } catch(e) { document.无法加入");
        } catch(e) { alert("ERR"); }
    }

    async function firstgetElementById('wait-overlay').classList.add('hidden'); }
    }

    function addMsg(txt,Start() {
        startTransition();
        fetch('/api/game', { method: 'POST', headers: color) {
        if(!txt) return;
        const d = document.createElement('div'); d.className="msg-block"; d.style.borderLeftColor=color; 
        // ★★★ 核心修复：打 {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'START_GAME', roomId: currentRoomId, userId: user.uid }) });
    }

    function startTransition() {
        document.getElementById('modal').style.display = 'none';
        playIntroSequence().then(() => {
            const term = document.getElementById('terminal');
            term.style.visibility = 'visible'; term.style字机逻辑优化 ★★★
        document.getElementById('story-box').appendChild(d); 
        setTimeout(()=>d.classList.add('show'), 50);
        
        let i = 0;
.opacity = 1;
            document.getElementById('hud-room').innerText = currentRoomId;
            document.getElementById('hud-hp').innerText = myProfile.public.hp;
            document.getElementById('hud-item').innerText = myProfile        function type() {
            if (i < txt.length) {
                d.innerHTML += txt.charAt(i);
                i++;
                document.getElementById('content-scroll').scrollTop = document.getElementById('content-scroll').scrollHeight;
                setTimeout(type, 10);
            }
        }
        type();
    }

    async function playIntroSequence() {
        const txt = document.getElementById('intro-content.private.hidden_items[0];

            // 关键修复：监听 current_scene，并只取属于自己的部分
            db.ref(`rooms/${currentRoomId}/current_scene`).on('value', snapshot => {
                const data = snapshot.val();
                if(data && data[user.uid]) { // 确保有自己的数据才渲染
                    renderScene(data[user.uid]);
                }
            });
        });
    }

    function renderScene(data) {
        document.getElementById('wait-overlay').classList.add('hidden');
        currentData = data; currentStage = 0;
        document.getElementById('story-box').innerHTML = "";
        document.');
        const door = document.getElementById('the-door');
        const layer = document.getElementById('intro-layer');
        layer.classList.remove('hidden'); layer.style.display = 'flex';
        
        const lines = ["正在初始化神经链路...", "已接入多元宇宙枢纽...", "坐标已确认。准备传送。", "祝你好运，行者。"];
        const wait = ms => new Promise(r => setTimeout(r, ms));
        
getElementById('controls').classList.remove('active');
        document.getElementById('next-trigger').style.display = 'none';
        
        const rawKw = data.image_keyword || "cyberpunk";
        const kw = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g,"");
        const url = `https://loremflickr.com/640/360/cyber        for (let line of lines) {
            txt.innerText = line; txt.style.opacity = 1; txt.style.transform = "scale(1)";
            await wait(1800); txt.style.opacity = 0; txt.style.transform = "scale(0.9)"; await wait(400);
        }
        txt.style.display = 'none'; door.style.opacity = 1; door.classList.add('zoom-effect'); 
        await wait(2000);
        layer.style.opacity = 0; setTimeout(() => layer.classList.add('hidden'), 1000);
        return true;
    }

    function initParticles(){const c=document.getElementById('canvas-container');if(!c)return;const s=punk,${kw}?random=${Date.now()}`;
        const img = document.getElementById('scene-img'); img.style.opacity=0; img.src=url;
        img.onload = () => { img.style.opacity=0.8; document.getElementById('loading-hint').innerText = "LIVE"; };

        addMsg(data.stage_1_env, 'var(--neon-cyan)');
        // 延迟new THREE.Scene();s.fog=new THREE.FogExp2(0,0.001);const cam=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,10显示点击按钮
        setTimeout(() => { document.getElementById('next-trigger').style.display = 'block'; }, 100);cam.position.z=100;const r=new THREE.WebGLRenderer({alpha:true});r.setSize(window.innerWidth,window.innerHeight);c.innerHTML='';c.appendChild(r.domElement);const g=new THREE.BufferGeometry();const v=[],cl=[];for(let i=0;000);
    }

    window.advanceFragment = function() {
        document.getElementById('next-trigger').style.display = 'none';
        // 保护逻辑：如果数据没加载好，不允许点
        if (!currentData) return;

        if (currentStage === 0) {
            currentStagei<1500;i++){v.push((Math.random()-0.5)*400 = 1;
            addMsg(currentData.stage_2_event, 'var(--neon-pink)');
            setTimeout(() => document.getElementById('next-trigger').style.display = 'block', 1000);
        } else if (currentStage === 1) {
            currentStage = 2;,(Math.random()-0.5)*400,(Math.random()-0.5)*400);const c=[0x00f3ff,0xbc13fe,0xff0055][Math.floor(Math.random()*3)];const hc=new THREE.Color(c);cl.push(hc.r,hc.g,hc.b);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));g.setAttribute('color',new THREE.Float32BufferAttribute(cl,3));const m=new THREE.PointsMaterial({size:2,vertexColors:true,opacity:0.7,transparent:
            addMsg(currentData.stage_3_analysis, 'var(--neon-yellow)');
            document.getElementById('btn-a').innerText = `[A] ${currentData.choices[0].text}`;
            document.getElementById('btn-b').innerText = `[B] ${currentData.choices[1].text}`;
            document.getElementById('controls').classList.add('active');
            const b = document.getElementById('content-scroll'); b.scrollTop = b.scrollHeight;
        }
    }

    async function makeChoice(text) {
        document.getElementById('wait-overlay').classList.remove('hidden');
        const choiceText = (text === 'A') ? currentData.choices[0].text : currentData.choices[1].text;
        try {
            await fetch('/api/game', { method: 'POST', headers:true});const p=new THREE.Points(g,m);s.add(p);const a=()=>{requestAnimationFrame(a);p.rotation.x+=0.0005;r.render(s,cam);};a();window.addEventListener('resize',()=>{cam.aspect=window.innerWidth/window.innerHeight;cam.updateProjectionMatrix();r.setSize(window.innerWidth,window.innerHeight);});}
</script>
 {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'MAKE_MOVE', roomId: currentRoomId, userId: user.uid, choiceText: choiceText }) });
        } catch(e) { document.getElementById('wait-overlay').classList.add('hidden'); }
    }

    function addMsg(txt, color) {
        if(!txt) return;
        const d = document.createElement('</body>
</html>
