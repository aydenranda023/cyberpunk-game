<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURAL_LINK // V15.0_CHAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=ZCOOL+QingKe+HuangYou&display=swap');
        
        :root { 
            --bg-color: #050505; 
            --neon-cyan: #00f3ff; 
            --neon-pink: #ff0055; 
            --neon-yellow: #fcee0a; 
            --neon-red: #ff2a2a;
            --ui-bg: rgba(10, 15, 20, 0.95);
            --font-title: 'ZCOOL QingKe HuangYou', cursive; 
            --font-body: 'Noto Sans SC', sans-serif; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-color); color: #eee; font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* BG */
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .scanlines { position: fixed; inset: 0; z-index: 2; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; }
        .hidden { display: none !important; }

        /* COMMON UI */
        .cyber-btn { 
            background: rgba(0, 20, 40, 0.8); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); 
            padding: 12px; font-family: var(--font-title); font-size: 1.1rem; width: 100%; margin-bottom: 10px; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .cyber-btn:active { background: var(--neon-cyan); color: #000; }
        .cyber-btn.danger { border-color: var(--neon-red); color: var(--neon-red); }
        
        input, textarea { background: #111; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 10px; width: 100%; margin-bottom: 10px; font-family: monospace; }

        /* SCREENS */
        #modal, #terminal { position: absolute; inset: 0; z-index: 100; display: flex; flex-direction: column; }
        #modal { justify-content: center; align-items: center; background: rgba(0,0,0,0.95); padding: 20px; }
        
        /* --- CHARACTER HUD (NEW) --- */
        #char-hud {
            width: 100%; max-width: 400px;
            display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 20px;
        }

        .hud-panel {
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 10px; position: relative;
        }
        .hud-title {
            font-family: var(--font-title); font-size: 0.9rem; letter-spacing: 2px; 
            position: absolute; top: -10px; left: 10px; background: #000; padding: 0 5px;
        }

        /* Public Panel (Green/Cyan) */
        .panel-public { border-color: var(--neon-cyan); }
        .panel-public .hud-title { color: var(--neon-cyan); }
        
        /* Private Panel (Red/Pink) */
        .panel-private { border-color: var(--neon-pink); background: repeating-linear-gradient(45deg, rgba(255,0,85,0.05), rgba(255,0,85,0.05) 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px); }
        .panel-private .hud-title { color: var(--neon-pink); }

        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
        .stat-label { color: #888; }
        .stat-val { color: #fff; font-weight: bold; }
        .item-tag { display: inline-block; background: #222; padding: 2px 6px; font-size: 0.75rem; margin-right: 5px; border: 1px solid #444; margin-top: 5px; }
        .item-tag.secret { border-color: var(--neon-pink); color: var(--neon-pink); }

        /* TERMINAL & GAME */
        #terminal { background: var(--term-bg); visibility: hidden; }
        header { height: 40px; padding: 0 15px; border-bottom: 1px solid var(--ui-border); display: flex; justify-content: space-between; align-items: center; background: #111; }
        #visual-container { height: 25vh; overflow: hidden; position: relative; border-bottom: 1px solid #333; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.5s; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .msg-block { margin-bottom: 15px; border-left: 3px solid #555; padding-left: 10px; color: #ccc; opacity: 0; transform: translateY(10px); transition: 0.5s; }
        .msg-block.show { opacity: 1; transform: translateY(0); }
        #controls-area { padding: 15px; background: #111; border-top: 1px solid #333; }
        
        #intro-layer { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; justify-content: center; align-items: center; color: var(--neon-cyan); font-family: var(--font-title); font-size: 1.5rem; transition: 1s; }
        #wait-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--neon-cyan); font-family: var(--font-title); }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="scanlines"></div>

<!-- SETUP / LOBBY / CHAR GEN -->
<div id="modal">
    <h1 style="color:var(--neon-cyan); font-family:var(--font-title); font-size:2.5rem; margin-bottom:10px">NEURAL LINK</h1>
    
    <!-- Step 1: Config -->
    <div id="step-config">
        <p style="color:#666; font-size:0.8rem">éœ€è¿æ¥äº‘ç«¯æ•°æ®åº“ä»¥å­˜å‚¨æ¡£æ¡ˆ</p>
        <textarea id="config-input" placeholder="ç²˜è´´ Firebase Config..." style="height:60px"></textarea>
        <button class="cyber-btn" onclick="initApp()">åˆå§‹åŒ– (INIT)</button>
    </div>

    <!-- Step 2: Character Sheet (Lobby) -->
    <div id="step-lobby" class="hidden" style="width:100%; text-align:center">
        
        <!-- è§’è‰² HUD -->
        <div id="char-hud">
            <!-- å…¬å¼€ä¿¡æ¯ -->
            <div class="hud-panel panel-public">
                <div class="hud-title">å…¬å¼€æ¡£æ¡ˆ (PUBLIC)</div>
                <div class="stat-row"><span class="stat-label">ä»£å·:</span> <span class="stat-val" id="hud-name">...</span></div>
                <div class="stat-row"><span class="stat-label">èŒä¸š:</span> <span class="stat-val" id="hud-role">...</span></div>
                <div class="stat-row"><span class="stat-label">ç”Ÿå‘½ä½“å¾:</span> <span class="stat-val" id="hud-hp" style="color:var(--neon-cyan)">100%</span></div>
                <div class="stat-row"><span class="stat-label">å¤–è§‚ç‰¹å¾:</span> <span class="stat-val" id="hud-look" style="font-size:0.8rem; text-align:right; width:60%">...</span></div>
                <div id="hud-public-items"></div>
            </div>

            <!-- ç§å¯†ä¿¡æ¯ -->
            <div class="hud-panel panel-private">
                <div class="hud-title">ç»å¯†æ•°æ® (EYES ONLY)</div>
                <div class="stat-row"><span class="stat-label">ç²¾ç¥çŠ¶æ€:</span> <span class="stat-val" id="hud-san" style="color:var(--neon-pink)">...</span></div>
                <div class="stat-row"><span class="stat-label">ç§˜å¯†ä»»åŠ¡:</span> <span class="stat-val" id="hud-secret" style="font-size:0.8rem; text-align:right; width:60%">...</span></div>
                <div id="hud-private-items"></div>
            </div>
        </div>

        <button class="cyber-btn" onclick="createRoom()">å»ºç«‹ä½é¢ (HOST)</button>
        <div style="display:flex; gap:10px">
            <input id="room-input" placeholder="è¾“å…¥ä½é¢ID" style="margin:0">
            <button class="cyber-btn" style="width:auto; margin:0" onclick="joinRoom()">åŠ å…¥</button>
        </div>
        
        <div style="margin-top:20px; border-top:1px dashed #333; padding-top:10px">
            <small style="color:#666; cursor:pointer" onclick="deleteCharacter()">[âš  é‡ç½®è§’è‰² / è‡ªæ€]</small>
        </div>
    </div>
    
    <!-- Waiting Room -->
    <div id="step-waiting" class="hidden" style="text-align:center">
        <h2 id="room-code-disp" style="color:var(--neon-yellow); font-size:3rem">....</h2>
        <p style="color:#888">ç­‰å¾…æ¥å…¥...</p>
        <div id="player-count" style="color:var(--neon-cyan); margin:20px 0">è¿æ¥æ•°: 1</div>
        <button class="cyber-btn" onclick="firstStart()">å¯åŠ¨ (START)</button>
    </div>
</div>

<!-- INTRO -->
<div id="intro-layer" class="hidden">ç¥ç»åŒæ­¥ä¸­...</div>

<!-- GAME TERMINAL -->
<div id="terminal">
    <header>
        <div>ROOM: <span id="game-room-id">0000</span></div>
        <div><span id="status-text" style="color:var(--neon-cyan)">LIVE</span></div>
    </header>
    <div id="visual-container">
        <img id="scene-img" src="">
        <div style="position:absolute; top:10px; left:10px; font-size:0.8rem; background:rgba(0,0,0,0.5); padding:2px 5px">VISUAL FEED</div>
    </div>
    <div id="content-scroll"><div id="story-box"></div></div>
    <div id="controls-area">
        <div id="wait-overlay" class="hidden"><p>ç­‰å¾…å…¨å‘˜å†³ç­–...</p></div>
        <div id="next-trigger" style="text-align:center; color:#888; display:none; padding:10px; cursor:pointer" onclick="advanceFragment()">â–¼ ç»§ç»­ â–¼</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">A</button>
            <button id="btn-b" class="cyber-btn" onclick="makeChoice('B')">B</button>
        </div>
    </div>
</div>

<script>
    let db, auth, user;
    let myProfile = null; // æ ¸å¿ƒï¼šå½“å‰è§’è‰²çš„å®Œæ•´æ•°æ®
    let currentRoomId = null;
    let currentData = null;
    let currentStage = 0;
    let preBuffer = { A: null, B: null };

    // --- 1. INIT & AUTH ---
    function initApp() {
        const cfgStr = document.getElementById('config-input').value.trim();
        if(!cfgStr) return alert("Config Required");
        try {
            let clean = cfgStr.includes("=") ? cfgStr.substring(cfgStr.indexOf('{'), cfgStr.lastIndexOf('}')+1) : cfgStr;
            const config = new Function("return " + clean)();
            firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.database();
            auth.signInAnonymously().then(u => {
                user = u.user;
                loadCharacter(); // â˜… æ ¸å¿ƒæ”¹å˜ï¼šç™»å½•åå…ˆåŠ è½½è§’è‰²
                initParticles();
            });
        } catch(e) { alert("é…ç½®é”™è¯¯"); }
    }

    // --- 2. CHARACTER SYSTEM (æ ¸å¿ƒæ–°é€»è¾‘) ---
    
    // åŠ è½½æˆ–åˆ›å»ºè§’è‰²
    function loadCharacter() {
        const userRef = db.ref('users/' + user.uid);
        userRef.once('value', snapshot => {
            const val = snapshot.val();
            if (val && val.profile) {
                // è€ç©å®¶ï¼šè¯»å–å­˜æ¡£
                myProfile = val.profile;
                renderHUD();
                showLobby();
            } else {
                // æ–°ç©å®¶ï¼šåˆ›å»ºæ–°è§’è‰²
                createNewCharacter();
            }
        });
    }

    // éšæœºç”Ÿæˆå™¨
    function createNewCharacter() {
        const roles = [
            { id: "Solo", label: "ç‹¬ç‹¼ä½£å…µ", hp: 120, items: ["çªå‡»æ­¥æª", "æ­¢ç—›è¯"], secret: "è¢«è’å‚é€šç¼‰" },
            { id: "Netrunner", label: "é»‘å®¢", hp: 80, items: ["æ¥å…¥ä»“", "æ™ºèƒ½æ‰‹æª"], secret: "è„‘ä¸­æœ‰æŸåçš„æ•°æ®" },
            { id: "Techie", label: "æŠ€å¸ˆ", hp: 100, items: ["å·¥ç¨‹æ‰‹å¥—", "éœ°å¼¹æª"], secret: "å·äº†å…¬å¸çš„åŸå‹æœº" },
            { id: "Corpo", label: "å…¬å¸ç‹—", hp: 90, items: ["é«˜çº§è¥¿è£…", "æ¶ˆéŸ³æ‰‹æª"], secret: "å…¶å®æ˜¯åŒé‡é—´è°" }
        ];
        
        const r = roles[Math.floor(Math.random() * roles.length)];
        const nameCode = Math.floor(Math.random()*999);
        
        myProfile = {
            name: `${r.id}_${nameCode}`,
            role: r.label,
            // ã€è¡¨ã€‘å…¬å¼€æ•°æ®
            public: {
                hp: r.hp,
                max_hp: r.hp,
                appearance: "æ™®é€šçš„èµ›åšæ ¼å¤–è§‚",
                visible_items: [r.items[0]] // ç¬¬ä¸€ä¸ªé“å…·å…¬å¼€
            },
            // ã€é‡Œã€‘ç§å¯†æ•°æ®
            private: {
                sanity: 100,
                hidden_items: [r.items[1]], // ç¬¬äºŒä¸ªé“å…·éšè—
                secret_mission: r.secret
            }
        };

        // å­˜å…¥æ°¸ä¹…æ•°æ®åº“
        db.ref('users/' + user.uid).set({
            profile: myProfile,
            created_at: firebase.database.ServerValue.TIMESTAMP
        });

        renderHUD();
        showLobby();
    }

    // æ¸²æŸ“ HUD
    function renderHUD() {
        // Public
        document.getElementById('hud-name').innerText = myProfile.name;
        document.getElementById('hud-role').innerText = myProfile.role;
        document.getElementById('hud-hp').innerText = myProfile.public.hp + "/" + myProfile.public.max_hp;
        document.getElementById('hud-look').innerText = myProfile.public.appearance;
        
        const pubBox = document.getElementById('hud-public-items');
        pubBox.innerHTML = myProfile.public.visible_items.map(i => `<span class="item-tag">${i}</span>`).join('');

        // Private
        document.getElementById('hud-san').innerText = myProfile.private.sanity + "%";
        document.getElementById('hud-secret').innerText = myProfile.private.secret_mission;
        
        const privBox = document.getElementById('hud-private-items');
        privBox.innerHTML = myProfile.private.hidden_items.map(i => `<span class="item-tag secret">ğŸ”’ ${i}</span>`).join('');
    }

    // è‡ªæ€/é‡ç½®
    function deleteCharacter() {
        if(confirm("ç¡®å®šè¦é”€æ¯ä¹‰ä½“å¹¶é‡ç½®èº«ä»½å—ï¼Ÿ(ä¸å¯é€†)")) {
            db.ref('users/' + user.uid).remove().then(() => {
                location.reload();
            });
        }
    }

    function showLobby() {
        document.getElementById('step-config').classList.add('hidden');
        document.getElementById('step-lobby').classList.remove('hidden');
        // æ­¤å¤„æš‚æ—¶ä¸æ˜¾ç¤ºåˆ—è¡¨ï¼Œå…ˆèšç„¦äºè§’è‰²å±•ç¤º
    }

    // --- 3. LOBBY & SYNC (é€‚é…æ–° Profile) ---

    async function createRoom() {
        const btn = document.querySelector('button[onclick="createRoom()"]');
        btn.innerText = "INIT..."; btn.disabled = true;
        try {
            // 1. Create
            const res = await fetch('/api/game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'CREATE_ROOM', userProfile: myProfile }) // å¸¦ä¸Šèº«ä»½ï¼
            });
            const data = await res.json();
            currentRoomId = data.roomId;

            // 2. Join Self
            await fetch('/api/game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'JOIN_ROOM', roomId: currentRoomId, userId: user.uid, userProfile: myProfile })
            });

            // UI
            document.getElementById('step-lobby').classList.add('hidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            document.getElementById('room-code-disp').innerText = currentRoomId;
            
            db.ref(`rooms/${currentRoomId}/players`).on('value', s => {
                document.getElementById('player-count').innerText = `è¿æ¥æ•°: ${s.numChildren()}`;
            });

        } catch(e) { alert(e.message); btn.disabled=false; }
    }

    async function joinRoom() {
        const rid = document.getElementById('room-input').value;
        try {
            const res = await fetch('/api/game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'JOIN_ROOM', roomId: rid, userId: user.uid, userProfile: myProfile }) // å¸¦ä¸Šèº«ä»½
            });
            if(res.ok) {
                currentRoomId = rid;
                enterGameMode();
            } else alert("è¿æ¥å¤±è´¥");
        } catch(e) { alert("ERR"); }
    }

    // --- 4. GAME LOOP (Same as V13.1) ---
    
    function firstStart() {
        enterGameMode(); // Listen first
        fetch('/api/game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'START_GAME', roomId: currentRoomId, userId: user.uid })
        });
    }

    function enterGameMode() {
        document.getElementById('modal').style.display = 'none';
        const term = document.getElementById('terminal');
        term.style.visibility = 'visible'; term.style.opacity = 1;
        document.getElementById('game-room-id').innerText = currentRoomId;

        db.ref(`rooms/${currentRoomId}/current_scene`).on('value', snapshot => {
            const data = snapshot.val();
            if(data) renderScene(data);
        });
    }

    async function makeChoice(text) {
        if(text !== "START_GAME") document.getElementById('wait-overlay').classList.remove('hidden');
        const choiceText = (text === "START_GAME") ? "Start" : (text === 'A' ? document.getElementById('btn-a').innerText : document.getElementById('btn-b').innerText);
        
        try {
            await fetch('/api/game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'MAKE_MOVE', roomId: currentRoomId, userId: user.uid, choiceText: choiceText })
            });
        } catch(e) { document.getElementById('wait-overlay').classList.add('hidden'); }
    }

    function renderScene(data) {
        document.getElementById('wait-overlay').classList.add('hidden');
        currentData = data; currentStage = 0;
        document.getElementById('story-box').innerHTML = "";
        document.getElementById('next-trigger').style.display = 'none';
        
        // Image
        const rawKw = data.image_keyword || "city";
        const kw = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g,"");
        const url = `https://loremflickr.com/640/360/cyberpunk,${kw}?random=${Date.now()}`;
        const img = document.getElementById('scene-img'); img.style.opacity=0; img.src=url;
        img.onload = () => img.style.opacity=0.8;

        // Text
        const addP = (txt, c) => {
            const d = document.createElement('div'); d.className="msg-block"; d.style.borderLeftColor=c; d.innerText=txt;
            document.getElementById('story-box').appendChild(d); setTimeout(()=>d.classList.add('show'), 50);
        }
        addP(data.stage_1_env, 'var(--neon-cyan)');
        setTimeout(()=>{
            addP(data.stage_2_event, 'var(--neon-pink)');
            setTimeout(()=>{
                addP(data.stage_3_analysis, 'var(--neon-yellow)');
                document.getElementById('btn-a').innerText = `[A] ${data.choices[0].text}`;
                document.getElementById('btn-b').innerText = `[B] ${data.choices[1].text}`;
                const b = document.getElementById('content-scroll'); b.scrollTop = b.scrollHeight;
            }, 1500);
        }, 1000);
    }

    function advanceFragment() { /* ... (Same logic, handled automatically now) ... */ }
    function initParticles(){const c=document.getElementById('canvas-container');if(!c)return;const s=new THREE.Scene();s.fog=new THREE.FogExp2(0,0.001);const cam=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1000);cam.position.z=100;const r=new THREE.WebGLRenderer({alpha:true});r.setSize(window.innerWidth,window.innerHeight);c.innerHTML='';c.appendChild(r.domElement);const g=new THREE.BufferGeometry();const v=[],cl=[];for(let i=0;i<1500;i++){v.push((Math.random()-0.5)*400,(Math.random()-0.5)*400,(Math.random()-0.5)*400);const c=[0x00f3ff,0xbc13fe,0xff0055][Math.floor(Math.random()*3)];const hc=new THREE.Color(c);cl.push(hc.r,hc.g,hc.b);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));g.setAttribute('color',new THREE.Float32BufferAttribute(cl,3));const m=new THREE.PointsMaterial({size:2,vertexColors:true,opacity:0.7,transparent:true});const p=new THREE.Points(g,m);s.add(p);const a=()=>{requestAnimationFrame(a);p.rotation.x+=0.0005;r.render(s,cam);};a();window.addEventListener('resize',()=>{cam.aspect=window.innerWidth/window.innerHeight;cam.updateProjectionMatrix();r.setSize(window.innerWidth,window.innerHeight);});}
    async function playIntroSequence(){const i=document.getElementById('intro-layer');i.classList.remove('hidden');i.style.opacity=1;await new Promise(r=>setTimeout(r,2000));i.style.opacity=0;setTimeout(()=>i.classList.add('hidden'),1000);}
</script>
</body>
</html>
