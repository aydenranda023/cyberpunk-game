<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURAL_LINK // CLOUD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* 保持 V11.2 的所有 CSS 样式不变，为了节省篇幅，请直接复用上一版的 CSS */
        /* ... (CSS 区域) ... */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=ZCOOL+QingKe+HuangYou&display=swap');
        :root { --bg-color: #000000; --term-bg: rgba(5, 5, 5, 0.95); --neon-cyan: #00f3ff; --neon-pink: #ff0055; --ui-border: rgba(255, 255, 255, 0.2); --font-title: 'ZCOOL QingKe HuangYou', cursive; --font-body: 'Noto Sans SC', sans-serif; }
        body { margin: 0; background: #000; color: #e0f0ff; font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        #terminal { width: 100%; height: 100%; display: flex; flex-direction: column; visibility: hidden; }
        .cyber-btn { background: rgba(10, 15, 20, 0.9); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px; font-family: var(--font-title); font-size: 1.2rem; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .hidden { display: none !important; }
        input, textarea { background: #111; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px; width: 100%; }
        /* 简单的布局补全 */
        header { height: 40px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; background: #111; border-bottom: 1px solid #333; }
        #visual-container { height: 30vh; overflow: hidden; position: relative; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.5s; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        #controls-area { padding: 20px; background: #111; border-top: 1px solid #333; }
        #modal { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .msg-block { margin-bottom: 15px; border-left: 2px solid #555; padding-left: 10px; color: #ccc; opacity: 0; transition: 0.5s; transform: translateY(10px); }
        .msg-block.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

<!-- SETUP -->
<div id="modal">
    <h1 style="color:var(--neon-cyan); font-family:var(--font-title); font-size:3rem">NEURAL CLOUD</h1>
    
    <!-- Step 1: Config -->
    <div id="step-config">
        <textarea id="config-input" placeholder="粘贴 Firebase Config..." style="height:80px"></textarea>
        <button class="cyber-btn" onclick="initFirebase()">初始化连接</button>
    </div>

    <!-- Step 2: Lobby -->
    <div id="step-lobby" class="hidden" style="width:100%; text-align:center">
        <p id="my-uid" style="color:#666; font-size:0.8rem; margin-bottom:20px">ID: ...</p>
        <button class="cyber-btn" onclick="createRoom()">创建位面 (CREATE)</button>
        <p style="margin:10px 0">- OR -</p>
        <input id="room-input" placeholder="输入位面ID (例如 8821)">
        <button class="cyber-btn" style="border-color:#ff0055; color:#ff0055" onclick="joinRoom()">接入位面 (JOIN)</button>
    </div>

    <!-- Step 3: Waiting -->
    <div id="step-waiting" class="hidden">
        <h2 id="room-code-disp" style="color:var(--neon-cyan); font-size:4rem">....</h2>
        <p>等待连接同步...</p>
        <button class="cyber-btn" onclick="firstStart()">开始同步 (START)</button>
    </div>
</div>

<!-- GAME -->
<div id="terminal">
    <header>
        <div>ROOM: <span id="hud-room">0000</span></div>
        <div id="status-text" style="color:var(--neon-cyan)">LIVE</div>
    </header>
    <div id="visual-container">
        <img id="scene-img" src="">
    </div>
    <div id="content-scroll">
        <div id="story-box"></div>
    </div>
    <div id="controls-area">
        <div id="wait-mask" class="hidden" style="text-align:center; color:#666; margin-bottom:10px">等待队友决策...</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">A</button>
            <button id="btn-b" class="cyber-btn" onclick="makeChoice('B')">B</button>
        </div>
    </div>
</div>

<script>
    let db, auth, user;
    let currentRoomId = null;

    // 1. Init Firebase
    function initFirebase() {
        const cfgStr = document.getElementById('config-input').value.trim();
        if(!cfgStr) return alert("Config Required");
        try {
            let clean = cfgStr;
            if(cfgStr.includes("=")) clean = cfgStr.substring(cfgStr.indexOf('{'), cfgStr.lastIndexOf('}')+1);
            const config = new Function("return " + clean)();
            
            firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.database();
            
            auth.signInAnonymously().then(u => {
                user = u.user;
                document.getElementById('step-config').classList.add('hidden');
                document.getElementById('step-lobby').classList.remove('hidden');
                document.getElementById('my-uid').innerText = "UID: " + user.uid.slice(0,5);
            });
        } catch(e) { alert("Config Error"); }
    }

    // 2. Create Room (API)
    async function createRoom() {
        const res = await fetch('/api/game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'CREATE_ROOM' })
        });
        const data = await res.json();
        currentRoomId = data.roomId;
        enterWaitingRoom();
    }

    // 3. Join Room (API)
    async function joinRoom() {
        const rid = document.getElementById('room-input').value;
        const res = await fetch('/api/game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'JOIN_ROOM', roomId: rid, userId: user.uid })
        });
        if(res.ok) {
            currentRoomId = rid;
            enterGameMode(); // Guest goes straight to game listener
        } else {
            alert("Join Failed");
        }
    }

    function enterWaitingRoom() {
        document.getElementById('step-lobby').classList.add('hidden');
        document.getElementById('step-waiting').classList.remove('hidden');
        document.getElementById('room-code-disp').innerText = currentRoomId;
    }

    // 4. First Start (Trigger Initial Scene)
    function firstStart() {
        // Join host to the room first
        fetch('/api/game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'JOIN_ROOM', roomId: currentRoomId, userId: user.uid })
        }).then(() => {
            // Then trigger first move (simulated empty move to start generation)
            // Actually, for MVP, let's just manually trigger a "START" move
            makeChoice("START_GAME");
        });
    }

    // 5. Game Mode & Sync Listener
    function enterGameMode() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('terminal').style.visibility = 'visible';
        document.getElementById('hud-room').innerText = currentRoomId;

        // LISTEN TO FIREBASE
        const sceneRef = db.ref(`rooms/${currentRoomId}/current_scene`);
        sceneRef.on('value', snapshot => {
            const data = snapshot.val();
            if (data) renderScene(data);
        });
    }

    // 6. Make Choice (API)
    async function makeChoice(text) {
        // Lock UI immediately
        document.getElementById('wait-mask').classList.remove('hidden');
        document.getElementById('btn-a').disabled = true;
        document.getElementById('btn-b').disabled = true;

        const choiceText = (text === "START_GAME") 
            ? "Game Start" 
            : (text === 'A' ? document.getElementById('btn-a').innerText : document.getElementById('btn-b').innerText);

        await fetch('/api/game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                action: 'MAKE_MOVE', 
                roomId: currentRoomId, 
                userId: user.uid,
                choiceText: choiceText
            })
        });
    }

    // 7. Render Logic
    function renderScene(data) {
        // Unlock UI
        document.getElementById('wait-mask').classList.add('hidden');
        document.getElementById('btn-a').disabled = false;
        document.getElementById('btn-b').disabled = false;

        // Image (LoremFlickr)
        const rawKw = data.image_keyword || "cyberpunk";
        const kw = rawKw.split(' ')[0].replace(/[^a-zA-Z]/g,"");
        const url = `https://loremflickr.com/640/360/cyberpunk,${kw}?random=${Date.now()}`;
        const img = document.getElementById('scene-img');
        img.style.opacity = 0;
        img.src = url;
        img.onload = () => img.style.opacity = 0.8;

        // Text
        const box = document.getElementById('story-box');
        box.innerHTML = "";
        
        const addP = (txt, color) => {
            const d = document.createElement('div');
            d.className = "msg-block";
            d.style.borderLeftColor = color;
            d.innerText = txt;
            box.appendChild(d);
            setTimeout(()=>d.classList.add('show'), 100);
        };

        addP(data.stage_1_env, 'cyan');
        setTimeout(()=>addP(data.stage_2_event, 'pink'), 1000);
        setTimeout(()=>addP(data.stage_3_analysis, 'yellow'), 2000);

        // Buttons
        document.getElementById('btn-a').innerText = `[A] ${data.choices[0].text}`;
        document.getElementById('btn-b').innerText = `[B] ${data.choices[1].text}`;
    }
</script>
</body>
</html>
