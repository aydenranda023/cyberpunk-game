<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURAL_LINK // V12.0_NETWORK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- 1. 引入 Firebase SDK (必须放在这里) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=ZCOOL+QingKe+HuangYou&display=swap');
        :root { --bg-color: #000000; --term-bg: rgba(5, 5, 5, 0.95); --neon-cyan: #00f3ff; --neon-purple: #bc13fe; --neon-pink: #ff0055; --neon-yellow: #fcee0a; --ui-border: rgba(255, 255, 255, 0.2); --font-title: 'ZCOOL QingKe HuangYou', cursive; --font-body: 'Noto Sans SC', sans-serif; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: #e0f0ff; font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .vignette { position: fixed; inset: 0; z-index: 1; pointer-events: none; background: radial-gradient(circle, transparent 40%, #000 100%); }
        .scanlines { position: fixed; inset: 0; z-index: 2; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; }
        
        /* NETWORK STATUS UI */
        .net-status {
            position: fixed; top: 10px; right: 10px; z-index: 20000;
            font-family: var(--font-title); font-size: 0.8rem; 
            color: #666; text-align: right;
        }
        .net-dot { display: inline-block; width: 8px; height: 8px; background: red; border-radius: 50%; margin-right: 5px; box-shadow: 0 0 5px red; }
        .net-online .net-dot { background: var(--neon-green); box-shadow: 0 0 5px var(--neon-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* TERMINAL */
        #terminal { position: relative; z-index: 100; width: 100%; height: 100%; display: flex; flex-direction: column; visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in; }
        header { height: 40px; padding: 0 15px; border-bottom: 1px solid var(--ui-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.6); font-family: var(--font-title); letter-spacing: 1px; font-size: 1rem; }
        #visual-container { position: relative; width: 100%; height: 30vh; min-height: 200px; max-height: 300px; border-bottom: 1px solid var(--ui-border); overflow: hidden; background: #000; flex-shrink: 0; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease; image-rendering: pixelated; filter: contrast(1.2) brightness(0.9) sepia(0.3) hue-rotate(170deg) saturate(0.6); }
        .overlay-ui { position: absolute; top: 10px; left: 10px; color: rgba(255,255,255,0.8); font-size: 0.8rem; text-shadow: 0 0 2px black; font-family: var(--font-title); z-index: 10; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 2px; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.4)); }
        .msg-block { padding-left: 12px; border-left: 3px solid #333; opacity: 0; transform: translateY(10px); transition: all 0.5s ease; font-size: 1rem; line-height: 1.6; color: #ddd; text-shadow: 0 0 2px rgba(0,0,0,0.8); }
        .msg-block.show { opacity: 1; transform: translateY(0); }
        .stage-1 { border-color: var(--neon-cyan); color: #d0ffff; }
        .stage-2 { border-color: var(--neon-pink); color: #ffd0d0; }
        .stage-3 { border-color: var(--neon-yellow); color: #ffffd0; font-weight: bold;}
        #controls-area { flex-shrink: 0; border-top: 1px solid var(--ui-border); background: rgba(0,0,0,0.9); padding-bottom: env(safe-area-inset-bottom); }
        #next-trigger { text-align: center; padding: 15px; color: #888; cursor: pointer; font-family: var(--font-title); font-size: 1.1rem; letter-spacing: 2px; display: none; border-bottom: 1px solid #333; }
        #next-trigger:hover { background: rgba(255,255,255,0.1); color: #fff; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--ui-border); opacity: 0.3; pointer-events: none; transition: 0.3s; }
        #controls.active { opacity: 1; pointer-events: all; }
        .cyber-btn { background: rgba(10, 15, 20, 0.95); border: none; color: var(--neon-cyan); padding: 20px 10px; font-family: var(--font-title); font-size: 1.2rem; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; }
        .cyber-btn:active { background: var(--neon-cyan); color: #000; }
        
        /* SETUP MODAL */
        #modal { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        h1 { font-family: var(--font-title); color: var(--neon-cyan); font-size: 3rem; text-shadow: 0 0 20px var(--neon-cyan); margin: 0; }
        p { color: #666; margin-top: 5px; letter-spacing: 3px; font-family: var(--font-title); }
        .start-btn { margin-top: 40px; padding: 15px 40px; border: 1px solid var(--neon-cyan); background: transparent; color: var(--neon-cyan); font-family: var(--font-title); font-size: 1.5rem; cursor: pointer; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }
        .config-area { margin-top: 20px; width: 80%; max-width: 400px; }
        textarea { width: 100%; height: 100px; background: #111; border: 1px dashed #444; color: #888; font-size: 0.8rem; padding: 10px; resize: none; }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<!-- STATUS HUD -->
<div class="net-status" id="net-hud">
    <span class="net-dot"></span> <span id="uid-display">OFFLINE</span>
</div>

<!-- SETUP -->
<div id="modal">
    <h1>神经漫游</h1>
    <p>V12.0 // DATABASE LINK</p>
    
    <!-- 配置输入区 -->
    <div class="config-area">
        <p style="font-size: 0.8rem; margin-bottom: 5px; color:#444">▼ 请在此粘贴 Firebase Config ▼</p>
        <textarea id="firebase-config-input" placeholder='粘贴 const firebaseConfig = { ... }'></textarea>
    </div>

    <button class="start-btn" onclick="bootSystem()">初始化 (INIT)</button>
</div>

<!-- TERMINAL (GAME UI) -->
<div id="terminal">
    <header>
        <div>NET: <span style="color:var(--neon-cyan)">SECURE</span></div>
        <div style="font-family:var(--font-body); font-size:0.7rem; opacity:0.7">SESSION: <span id="session-id">LOCAL</span></div>
    </header>

    <div id="visual-container">
        <img id="scene-img" src="" alt="">
        <div class="overlay-ui">
            <span>LOC: <span id="loc-id">加载中...</span></span>
            <span id="loading-hint" style="color:var(--neon-yellow); margin-left:10px">正在获取视觉信号...</span>
        </div>
    </div>

    <div id="content-scroll">
        <div id="msg-1" class="msg-block stage-1"></div>
        <div id="msg-2" class="msg-block stage-2"></div>
        <div id="msg-3" class="msg-block stage-3"></div>
    </div>

    <div id="controls-area">
        <div id="next-trigger" onclick="advanceFragment()">▼ 点击继续数据流 ▼</div>
        <div id="controls">
            <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">选项 A</button>
            <button id="btn-b" class="cyber-btn" onclick="makeChoice('B')">选项 B</button>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let db, auth, user;
    let history = [];
    let currentData = null;
    let currentStage = 0;
    let preBuffer = { A: null, B: null };

    // --- 1. 启动逻辑 ---
    function bootSystem() {
        // 获取用户输入的 Config
        const configStr = document.getElementById('firebase-config-input').value.trim();
        
        if (!configStr) {
            alert("错误：必须粘贴 Firebase 配置代码才能联网。");
            return;
        }

        // 尝试解析并连接 Firebase
        try {
            connectToFirebase(configStr);
        } catch (e) {
            alert("配置解析失败，请确保复制了完整的代码块。\n错误: " + e.message);
            return;
        }

        document.getElementById('modal').style.display = 'none';
        initParticles(); 
        
        // 开始游戏流程
        fetchChapterData("START_GAME", true).then(pkg => {
            document.getElementById('terminal').style.visibility = 'visible';
            document.getElementById('terminal').style.opacity = 1;
            if(pkg) renderChapter(pkg, true);
        });
    }

    // --- 2. FIREBASE 连接逻辑 (V12 新增) ---
    function connectToFirebase(configText) {
        // 这是一个黑魔法：利用 eval 解析用户粘贴的 config 对象
        // 实际上我们需要提取 {} 中间的内容
        let cleanConfig = configText;
        if(configText.includes("const firebaseConfig =")) {
            const start = configText.indexOf('{');
            const end = configText.lastIndexOf('}') + 1;
            cleanConfig = configText.substring(start, end);
        }
        
        // 这种 eval 在这里是安全的，因为是用户自己粘贴的配置
        // 为了更严谨，我们手动解析 JSON（需要用户输入的是标准 JSON）
        // 但为了容错，我们这里假设用户粘贴的是 JS 对象字面量，使用 Function 构造器解析
        const config = new Function("return " + cleanConfig)();

        // 初始化 Firebase
        firebase.initializeApp(config);
        auth = firebase.auth();
        db = firebase.database();

        // 匿名登录
        auth.signInAnonymously()
            .then(() => {
                console.log("Logged in anonymously");
            })
            .catch((error) => {
                console.error("Login Error", error);
                alert("登录失败: " + error.message);
            });

        // 监听登录状态
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                const shortUid = u.uid.substring(0, 5).toUpperCase();
                
                // 更新 UI
                const hud = document.getElementById('net-hud');
                hud.classList.add('net-online');
                document.getElementById('uid-display').innerText = "ID: " + shortUid;
                
                // 在数据库里注册自己
                db.ref('users/' + u.uid).set({
                    online: true,
                    last_seen: firebase.database.ServerValue.TIMESTAMP,
                    platform: navigator.userAgent
                });
            } else {
                document.getElementById('net-hud').classList.remove('net-online');
                document.getElementById('uid-display').innerText = "OFFLINE";
            }
        });
    }

    // --- 下面是 V11 的游戏逻辑 (保留不动) ---
    // ... 这里包含了 callGemini, fetchChapterData, renderChapter 等所有函数 ...
    // 为了代码简洁，我把下面这部分省略了，请你保留 V11.2 中 script 标签内原有的那些函数。
    // 只需要把你原来的 callGemini, fetchChapterData, renderChapter 等函数完整复制到这里即可。
    
    // ↓↓↓↓↓↓ 把原来的 JS 逻辑粘贴在这里 ↓↓↓↓↓↓
    
    // [这里粘贴 V11.2 的 callGemini 及其后的所有函数]
    // [initParticles 也要粘贴]
    
    // 为了方便你直接复制，我把需要的核心函数再写一遍简化版放在下面，你可以直接替换：

    async function callGemini(userText) {
        const sysPrompt = `ROLE: Cyberpunk Novel. LANG: Chinese. JSON ONLY. { "image_keyword": "noun", "stage_1_env": "...", "stage_2_event": "...", "stage_3_analysis": "...", "choices": [{"text":"A"},{"text":"B"}] }`;
        const historyForBackend = [{ role: "user", parts: [{ text: sysPrompt }] }, ...history.slice(-4)];
        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history: historyForBackend, prompt: userText })
            });
            const data = await res.json();
            return JSON.parse(data.text.replace(/```json|```/g, "").trim());
        } catch (e) { console.error(e); return null; }
    }

    async function fetchChapterData(userInput, isStart = false) {
        const prompt = isStart ? "游戏开始" : `玩家选择: "${userInput}"`;
        try {
            const json = await callGemini(prompt);
            if (isStart) { history.push({ role: "user", parts: [{text: "Start"}]}); history.push({ role: "model", parts: [{text: JSON.stringify(json)}]}); }
            const rawKw = json.image_keyword || "cyberpunk";
            const keyword = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g, "");
            const imgUrl = `https://loremflickr.com/640/360/cyberpunk,${keyword}?random=${Date.now()}`;
            const imgPromise = new Promise(r => { const i=new Image(); i.onload=()=>r(imgUrl); i.onerror=()=>r(imgUrl); i.src=imgUrl; setTimeout(()=>r(imgUrl),2000); });
            return { json, imgPromise };
        } catch (e) { return null; }
    }

    function renderChapter(pkg, silent = false) {
        if(!pkg) return;
        const data = pkg.json; currentData = data; currentStage = 0;
        ['msg-1','msg-2','msg-3'].forEach(id=>{document.getElementById(id).innerHTML="";document.getElementById(id).classList.remove('show');});
        document.getElementById('controls').classList.remove('active'); document.getElementById('next-trigger').style.display='none';
        pkg.imgPromise.then(url=>{document.getElementById('scene-img').src=url; document.getElementById('scene-img').onload=()=>{document.getElementById('scene-img').style.opacity=0.8;}});
        const m1=document.getElementById('msg-1');
        if(silent){m1.classList.add('show');m1.innerHTML=data.stage_1_env;showNextTrigger();triggerPreload(data.choices);}
        else{requestAnimationFrame(()=>m1.classList.add('show'));typeWriter(m1,data.stage_1_env,()=>{showNextTrigger();triggerPreload(data.choices);});}
    }

    window.advanceFragment = function() {
        document.getElementById('next-trigger').style.display='none';
        if(currentStage===0){currentStage=1;const e=document.getElementById('msg-2');e.classList.add('show');typeWriter(e,currentData.stage_2_event,showNextTrigger);}
        else if(currentStage===1){currentStage=2;const e=document.getElementById('msg-3');e.classList.add('show');typeWriter(e,currentData.stage_3_analysis,()=>{document.getElementById('btn-a').innerText=`[A] ${currentData.choices[0].text}`;document.getElementById('btn-b').innerText=`[B] ${currentData.choices[1].text}`;document.getElementById('controls').classList.add('active');});}
    }

    window.makeChoice = async function(id) {
        const txt = currentData.choices[id==='A'?0:1].text;
        document.getElementById('controls').classList.remove('active');
        history.push({role:"user",parts:[{text:`选:${txt}`}]});
        const buf = preBuffer[id];
        if(buf){history.push({role:"model",parts:[{text:JSON.stringify(buf.json)}]});renderChapter(buf);}
        else{const d=await fetchChapterData(txt);renderChapter(d);}
    }

    function triggerPreload(choices){ preBuffer={A:null,B:null}; ['A','B'].forEach(async(k,i)=>{try{preBuffer[k]=await fetchChapterData(choices[i].text);}catch{}});}
    function typeWriter(el,txt,cb){let i=0;const b=document.getElementById('content-scroll');function t(){if(i<txt.length){el.innerHTML+=txt.charAt(i);i++;b.scrollTop=b.scrollHeight;setTimeout(t,10);}else if(cb)cb();}t();}
    function showNextTrigger(){document.getElementById('next-trigger').style.display='block';document.getElementById('content-scroll').scrollTop=9999;}
    function initParticles(){const c=document.getElementById('canvas-container');const s=new THREE.Scene();s.fog=new THREE.FogExp2(0,0.001);const cam=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1000);cam.position.z=100;const r=new THREE.WebGLRenderer({alpha:true});r.setSize(window.innerWidth,window.innerHeight);c.appendChild(r.domElement);const g=new THREE.BufferGeometry();const v=[],cl=[];for(let i=0;i<1500;i++){v.push((Math.random()-0.5)*400,(Math.random()-0.5)*400,(Math.random()-0.5)*400);const c=[0x00f3ff,0xbc13fe,0xff0055][Math.floor(Math.random()*3)];const hc=new THREE.Color(c);cl.push(hc.r,hc.g,hc.b);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));g.setAttribute('color',new THREE.Float32BufferAttribute(cl,3));const m=new THREE.PointsMaterial({size:2,vertexColors:true,opacity:0.7,transparent:true});const p=new THREE.Points(g,m);s.add(p);const a=()=>{requestAnimationFrame(a);p.rotation.x+=0.0005;r.render(s,cam);};a();}

</script>
</body>
</html>
