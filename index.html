<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURAL_LINK // MOBILE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* 引入中文字体：站酷黄油体(标题工业感) + Noto Sans(正文易读) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=ZCOOL+QingKe+HuangYou&display=swap');

        :root {
            --bg-color: #000000;
            --term-bg: rgba(5, 5, 5, 0.95);
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-pink: #ff0055;
            --neon-yellow: #fcee0a;
            --ui-border: rgba(255, 255, 255, 0.2);
            /* 字体定义 */
            --font-title: 'ZCOOL QingKe HuangYou', cursive;
            --font-body: 'Noto Sans SC', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: #e0f0ff;
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden; /* 禁止整个页面滚动 */
            display: flex;
            flex-direction: column;
        }

        /* --- BACKGROUND LAYERS --- */
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .vignette { position: fixed; inset: 0; z-index: 1; pointer-events: none; background: radial-gradient(circle, transparent 40%, #000 100%); }
        .scanlines { position: fixed; inset: 0; z-index: 2; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; }

        /* --- INTRO LAYER --- */
        #intro-layer {
            position: fixed; inset: 0; z-index: 9000;
            background: #000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; text-align: center; transition: opacity 1s;
        }
        .intro-text { 
            font-family: var(--font-title); 
            font-size: 1.8rem; color: var(--neon-cyan); 
            opacity: 0; transform: scale(0.9); transition: opacity 1s, transform 1s; 
            text-shadow: 0 0 10px var(--neon-cyan); letter-spacing: 2px; margin-bottom: 30px;
        }
        .door-frame { position: absolute; width: 80px; height: 160px; border: 2px solid #fff; box-shadow: 0 0 50px #fff; opacity: 0; transition: 2s; }
        .zoom-effect { animation: zoomIn 2.5s forwards ease-in; }
        @keyframes zoomIn { 0% { transform: scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: scale(60); opacity: 0; } }

        /* --- MAIN TERMINAL (Flex Layout) --- */
        #terminal {
            position: relative; z-index: 100;
            width: 100%; height: 100%;
            display: flex; 
            flex-direction: column; /* 垂直排列 */
            visibility: hidden; opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        /* 1. HEADER */
        header {
            height: 40px;
            padding: 0 15px;
            border-bottom: 1px solid var(--ui-border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6);
            font-family: var(--font-title); letter-spacing: 1px; font-size: 1rem;
        }

        /* 2. VISUAL (Mobile Optimized) */
        #visual-container {
            position: relative;
            width: 100%;
            /* 关键：手机上限制高度，留给文字 */
            height: 30vh; 
            min-height: 200px; 
            max-height: 300px;
            border-bottom: 1px solid var(--ui-border);
            overflow: hidden; background: #000;
            flex-shrink: 0; /* 禁止被压缩 */
        }
        #scene-img {
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0; transition: opacity 0.5s ease;
            image-rendering: pixelated; 
            filter: contrast(1.2) brightness(0.9) sepia(0.3) hue-rotate(170deg) saturate(0.6);
        }
        .overlay-ui {
            position: absolute; top: 10px; left: 10px;
            color: rgba(255,255,255,0.8); font-size: 0.8rem;
            text-shadow: 0 0 2px black; font-family: var(--font-title);
            z-index: 10; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 2px;
        }

        /* 3. CONTENT (Scrollable) */
        #content-scroll {
            flex: 1; /* 占据剩余所有空间 */
            overflow-y: auto; /* 只有这里滚动 */
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.4));
        }
        
        .msg-block {
            padding-left: 12px; border-left: 3px solid #333;
            opacity: 0; transform: translateY(10px); transition: all 0.5s ease;
            font-size: 1rem; line-height: 1.6; color: #ddd;
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
        }
        .msg-block.show { opacity: 1; transform: translateY(0); }
        
        .stage-1 { border-color: var(--neon-cyan); color: #d0ffff; }
        .stage-2 { border-color: var(--neon-pink); color: #ffd0d0; }
        .stage-3 { border-color: var(--neon-yellow); color: #ffffd0; font-weight: bold;}

        /* 4. CONTROLS (Bottom Fixed) */
        #controls-area {
            flex-shrink: 0;
            border-top: 1px solid var(--ui-border);
            background: rgba(0,0,0,0.9);
            padding-bottom: env(safe-area-inset-bottom); /* 适配全面屏底部 */
        }

        #next-trigger {
            text-align: center; padding: 15px; color: #888; cursor: pointer;
            font-family: var(--font-title); font-size: 1.1rem; letter-spacing: 2px;
            display: none; border-bottom: 1px solid #333;
        }
        #next-trigger:hover { background: rgba(255,255,255,0.1); color: #fff; }

        #controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
            background: var(--ui-border); opacity: 0.3; pointer-events: none; transition: 0.3s;
        }
        #controls.active { opacity: 1; pointer-events: all; }

        .cyber-btn {
            background: rgba(10, 15, 20, 0.95); border: none; 
            color: var(--neon-cyan);
            padding: 20px 10px; /* 增加点击区域 */
            font-family: var(--font-title); font-size: 1.2rem; letter-spacing: 1px;
            cursor: pointer; transition: all 0.2s;
        }
        .cyber-btn:active { background: var(--neon-cyan); color: #000; }

        /* SETUP MODAL */
        #modal {
            position: fixed; inset: 0; z-index: 10000; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        h1 { font-family: var(--font-title); color: var(--neon-cyan); font-size: 3rem; text-shadow: 0 0 20px var(--neon-cyan); margin: 0; }
        p { color: #666; margin-top: 5px; letter-spacing: 3px; font-family: var(--font-title); }
        .start-btn {
            margin-top: 40px; padding: 15px 40px;
            border: 1px solid var(--neon-cyan); background: transparent;
            color: var(--neon-cyan); font-family: var(--font-title); font-size: 1.5rem;
            cursor: pointer; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<!-- SETUP -->
<div id="modal">
    <h1>神经漫游</h1>
    <p>NEURAL LINK V11.1</p>
    <button class="start-btn" onclick="bootSystem()">连接网络 (JACK IN)</button>
</div>

<!-- INTRO -->
<div id="intro-layer" style="display:none">
    <div id="intro-content" class="intro-text"></div>
    <div id="the-door" class="door-frame"></div>
</div>

<!-- TERMINAL -->
<div id="terminal">
    <header>
        <div>NET: <span style="color:var(--neon-cyan)">ONLINE</span></div>
        <div style="font-family:var(--font-body); font-size:0.7rem; opacity:0.7">SECURE_CONN</div>
    </header>

    <div id="visual-container">
        <img id="scene-img" src="" alt="">
        <div class="overlay-ui">
            <span>LOC: <span id="loc-id">加载中...</span></span>
            <span id="loading-hint" style="color:var(--neon-yellow); margin-left:10px">正在获取视觉信号...</span>
        </div>
    </div>

    <div id="content-scroll">
        <div id="msg-1" class="msg-block stage-1"></div>
        <div id="msg-2" class="msg-block stage-2"></div>
        <div id="msg-3" class="msg-block stage-3"></div>
    </div>

    <div id="controls-area">
        <div id="next-trigger" onclick="advanceFragment()">▼ 点击继续数据流 ▼</div>
        <div id="controls">
            <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">选项 A</button>
            <button id="btn-b" class="cyber-btn" onclick="makeChoice('B')">选项 B</button>
        </div>
    </div>
</div>

<script>
    let history = [];
    let currentData = null;
    let currentStage = 0;
    let firstChapterPromise = null;
    let preBuffer = { A: null, B: null };
    let mouseX = 0, mouseY = 0;

    // --- 启动逻辑 ---
    function bootSystem() {
        document.getElementById('modal').style.display = 'none';
        initParticles(); 
        const introPromise = playIntroSequence();
        firstChapterPromise = fetchChapterData("START_GAME", true);

        introPromise.then(async () => {
            const introLayer = document.getElementById('intro-layer');
            introLayer.style.opacity = 0;
            setTimeout(() => introLayer.style.display = 'none', 1000);
            
            const term = document.getElementById('terminal');
            term.style.visibility = 'visible';
            term.style.opacity = 1;

            const pkg = await firstChapterPromise;
            if(pkg) renderChapter(pkg, true);
        });
    }

    // --- 后端 API 调用 (Prompt 已改为中文) ---
    async function callGemini(userText) {
        const sysPrompt = `
        你是一个赛博朋克风格的文字冒险游戏GM。
        
        【核心规则】
        1. 语言必须是 **中文 (Chinese Simplified)**。文风要冷峻、硬核、带点翻译腔的赛博朋克味。
        2. 剧情要紧凑，冲突激烈。
        3. 输出必须是纯 JSON 格式。不要 Markdown。
        
        【JSON 格式要求】
        {
            "image_keyword": "提取一个具体的英文单词(名词)，用于生成图片 (例如: gun, rain, neon, robot, eye, alley)",
            "stage_1_env": "第一段：环境描写。视觉、听觉、气味。100字左右。",
            "stage_2_event": "第二段：突发事件。发生了什么？谁出现了？80字左右。",
            "stage_3_analysis": "第三段：危机分析。主角现在的处境和心理。50字左右。",
            "is_game_over": false,
            "choices": [
                {"text": "选项A的中文描述 (短促有力)"}, 
                {"text": "选项B的中文描述 (短促有力)"}
            ]
        }
        `;
        
        const historyForBackend = [
            { role: "user", parts: [{ text: sysPrompt }] },
            ...history.slice(-4)
        ];

        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history: historyForBackend, prompt: userText })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            return JSON.parse(data.text.replace(/```json|```/g, "").trim());
        } catch (e) {
            console.error(e);
            alert("连接神经中枢失败，请刷新页面。");
            return null;
        }
    }

    // --- 数据获取 & 图片流 (同 V10.1) ---
    async function fetchChapterData(userInput, isStart = false) {
        const prompt = isStart ? "游戏开始。生成第一个随机的平行世界场景。" : `玩家选择了: "${userInput}"。继续剧情。`;
        try {
            const json = await callGemini(prompt);
            if (isStart) {
                history.push({ role: "user", parts: [{text: "Start Game"}]});
                history.push({ role: "model", parts: [{text: JSON.stringify(json)}]});
            }
            
            const rawKw = json.image_keyword || "city";
            const keyword = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g, "") || "cyberpunk";
            const imgUrl = `https://loremflickr.com/640/360/cyberpunk,${keyword}?random=${Date.now()}`;
            
            const imgPromise = new Promise(resolve => {
                const img = new Image();
                const t = setTimeout(()=>resolve(imgUrl), 3000); // 超时兜底
                img.onload = () => { clearTimeout(t); resolve(imgUrl); };
                img.onerror = () => { clearTimeout(t); resolve(imgUrl); };
                img.src = imgUrl;
            });
            return { json, imgPromise };
        } catch (e) { return null; }
    }

    // --- 渲染逻辑 (针对手机优化滚动) ---
    function renderChapter(pkg, silent = false) {
        if(!pkg) return;
        const data = pkg.json;
        currentData = data; currentStage = 0;

        ['msg-1','msg-2','msg-3'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = ""; el.classList.remove('show');
        });
        document.getElementById('controls').classList.remove('active');
        document.getElementById('next-trigger').style.display = 'none';
        document.getElementById('loc-id').innerText = "区域_" + Math.floor(Math.random()*999);

        const imgEl = document.getElementById('scene-img');
        imgEl.style.opacity = 0;
        document.getElementById('loading-hint').innerText = "接收信号...";
        
        pkg.imgPromise.then(url => {
            imgEl.src = url;
            imgEl.onload = () => {
                imgEl.style.opacity = 0.8;
                document.getElementById('loading-hint').innerText = "实时影像";
            };
        });

        const m1 = document.getElementById('msg-1');
        if(silent) {
            m1.classList.add('show'); m1.innerHTML = data.stage_1_env;
            showNextTrigger(); triggerPreload(data.choices);
        } else {
            requestAnimationFrame(() => m1.classList.add('show'));
            typeWriter(m1, data.stage_1_env, () => {
                showNextTrigger(); triggerPreload(data.choices);
            });
        }
    }

    window.advanceFragment = function() {
        document.getElementById('next-trigger').style.display = 'none';
        if (currentStage === 0) {
            currentStage = 1;
            const m2 = document.getElementById('msg-2');
            m2.classList.add('show');
            typeWriter(m2, currentData.stage_2_event, showNextTrigger);
        } else if (currentStage === 1) {
            currentStage = 2;
            const m3 = document.getElementById('msg-3');
            m3.classList.add('show');
            typeWriter(m3, currentData.stage_3_analysis, () => {
                document.getElementById('btn-a').innerText = `[A] ${currentData.choices[0].text}`;
                document.getElementById('btn-b').innerText = `[B] ${currentData.choices[1].text}`;
                document.getElementById('controls').classList.add('active');
                // 自动滚动到底部
                const scrollBox = document.getElementById('content-scroll');
                scrollBox.scrollTop = scrollBox.scrollHeight;
            });
        }
    }

    window.makeChoice = async function(choiceId) {
        const choiceText = currentData.choices[choiceId === 'A' ? 0 : 1].text;
        document.getElementById('controls').classList.remove('active');
        history.push({ role: "user", parts: [{ text: `玩家选择: ${choiceText}` }] });

        const bufferItem = preBuffer[choiceId];
        if (bufferItem) {
            history.push({ role: "model", parts: [{ text: JSON.stringify(bufferItem.json) }] });
            renderChapter(bufferItem);
        } else {
            const newData = await fetchChapterData(choiceText);
            renderChapter(newData);
        }
    }

    function triggerPreload(choices) {
        preBuffer = { A: null, B: null };
        ['A', 'B'].forEach(async (key, idx) => {
             try { preBuffer[key] = await fetchChapterData(choices[idx].text); } catch(e) {}
        });
    }

    // --- 工具与特效 ---
    function typeWriter(el, txt, cb) {
        let i = 0; el.innerHTML = "";
        const scrollBox = document.getElementById('content-scroll');
        function t() {
            if (i < txt.length) {
                el.innerHTML += txt.charAt(i); i++;
                scrollBox.scrollTop = scrollBox.scrollHeight; // 自动跟随滚动
                setTimeout(t, 10);
            } else if (cb) cb();
        } t();
    }
    
    function showNextTrigger() { 
        document.getElementById('next-trigger').style.display = 'block';
        document.getElementById('content-scroll').scrollTop = document.getElementById('content-scroll').scrollHeight;
    }

    function initParticles() {
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.001);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.z = 100;
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        const geometry = new THREE.BufferGeometry();
        const vertices = [], colors = [];
        const colorPalette = [new THREE.Color(0x00f3ff), new THREE.Color(0xbc13fe), new THREE.Color(0xff0055)];
        for (let i = 0; i < 1500; i++) {
            vertic
