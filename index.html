<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL_LINK // ONLINE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        :root { --bg-color: #000000; --term-bg: rgba(5, 5, 5, 0.9); --neon-cyan: #00f3ff; --neon-purple: #bc13fe; --neon-pink: #ff0055; --ui-border: rgba(255, 255, 255, 0.15); }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: #e0f0ff; font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .vignette { position: fixed; inset: 0; z-index: 1; pointer-events: none; background: radial-gradient(circle, transparent 40%, #000 100%); }
        .scanlines { position: fixed; inset: 0; z-index: 2; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; }
        
        /* INTRO */
        #intro-layer { position: fixed; inset: 0; z-index: 9000; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s; }
        .intro-text { font-size: 1.5rem; color: var(--neon-cyan); opacity: 0; transform: scale(0.9); transition: opacity 1s, transform 1s; text-shadow: 0 0 10px var(--neon-cyan); margin-bottom: 20px; }
        .door-frame { position: absolute; width: 100px; height: 200px; border: 2px solid #fff; box-shadow: 0 0 50px #fff; opacity: 0; transition: 2s; }
        .zoom-effect { animation: zoomIn 2.5s forwards ease-in; }
        @keyframes zoomIn { 0% { transform: scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: scale(60); opacity: 0; } }

        /* TERMINAL */
        #terminal { position: absolute; z-index: 100; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 850px; height: 92vh; background: var(--term-bg); border: 1px solid var(--ui-border); backdrop-filter: blur(15px); display: flex; visibility: hidden; opacity: 0; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); clip-path: polygon(30px 0, 100% 0, 100% calc(100% - 30px), calc(100% - 30px) 100%, 0 100%, 0 30px); transition: opacity 0.5s ease-in; }
        header { padding: 15px 25px; border-bottom: 1px solid var(--ui-border); display: flex; justify-content: space-between; background: rgba(0, 0, 0, 0.4); font-size: 0.8rem; letter-spacing: 2px; }
        #visual-container { position: relative; width: 100%; height: 300px; border-bottom: 1px solid var(--ui-border); overflow: hidden; background: #000; }
        #scene-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease; image-rendering: pixelated; filter: contrast(1.3) brightness(0.8) sepia(0.4) hue-rotate(150deg) saturate(0.5); }
        .overlay-ui { position: absolute; top: 15px; left: 15px; color: rgba(255,255,255,0.8); font-size: 0.75rem; text-shadow: 0 0 2px black; z-index: 10; background: rgba(0,0,0,0.5); padding: 5px; }
        #content-scroll { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px;}
        .msg-block { padding-left: 15px; border-left: 2px solid #333; opacity: 0; transform: translateY(20px); transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); font-size: 1.15rem; line-height: 1.6; color: #ccc; }
        .msg-block.show { opacity: 1; transform: translateY(0); }
        .stage-1 { border-color: var(--neon-cyan); color: #ccffff; } .stage-2 { border-color: var(--neon-pink); color: #ffccdd; } .stage-3 { border-color: var(--neon-yellow); color: #ffffcc; font-style: italic; }
        #next-trigger { text-align: center; padding: 20px; color: #666; cursor: pointer; border-top: 1px solid #333; display: none; font-size: 0.9rem; transition: 0.3s; }
        #next-trigger:hover { background: rgba(255,255,255,0.05); color: white; letter-spacing: 2px; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--ui-border); opacity: 0.3; pointer-events: none; transition: 0.3s; }
        #controls.active { opacity: 1; pointer-events: all; }
        .cyber-btn { background: rgba(0,0,0,0.6); border: none; color: var(--neon-cyan); padding: 25px; font-family: inherit; font-size: 1rem; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .cyber-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
        
        /* Start Button Layer */
        #start-layer { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<!-- START SCREEN -->
<div id="start-layer">
    <h1 style="color:var(--neon-cyan); font-size: 2.5rem; margin-bottom: 20px;">NEURAL LINK</h1>
    <button class="cyber-btn" style="border:1px solid var(--neon-cyan); width: 200px" onclick="bootSystem()">CONNECT</button>
</div>

<!-- INTRO -->
<div id="intro-layer" style="display:none">
    <div id="intro-content" class="intro-text"></div>
    <div id="the-door" class="door-frame"></div>
</div>

<!-- TERMINAL -->
<div id="terminal">
    <header><div>NET: <span style="color:var(--neon-cyan)">ONLINE</span></div><div>SECURE_CONN</div></header>
    <div id="visual-container">
        <img id="scene-img" src="" alt="">
        <div class="overlay-ui"><span>LOC: <span id="loc-id">UNKNOWN</span></span><span>VISUAL: <span id="loading-hint" style="color:yellow;">SEARCHING...</span></span></div>
    </div>
    <div id="content-scroll">
        <div id="msg-1" class="msg-block stage-1"></div>
        <div id="msg-2" class="msg-block stage-2"></div>
        <div id="msg-3" class="msg-block stage-3"></div>
        <div id="next-trigger" onclick="advanceFragment()">▼ NEXT ▼</div>
    </div>
    <div id="controls">
        <button id="btn-a" class="cyber-btn" onclick="makeChoice('A')">OPTION A</button>
        <button id="btn-b" class="cyber-btn" onclick="makeChoice('B')">OPTION B</button>
    </div>
</div>

<script>
    let history = [];
    let currentData = null;
    let currentStage = 0;
    let firstChapterPromise = null;
    let preBuffer = { A: null, B: null };

    function bootSystem() {
        document.getElementById('start-layer').style.display = 'none';
        initParticles();
        const introPromise = playIntroSequence();
        firstChapterPromise = fetchChapterData("START_GAME", true); // No API Key needed here!

        introPromise.then(async () => {
            document.getElementById('intro-layer').style.opacity = 0;
            setTimeout(() => document.getElementById('intro-layer').style.display = 'none', 1000);
            document.getElementById('terminal').style.visibility = 'visible';
            document.getElementById('terminal').style.opacity = 1;
            const pkg = await firstChapterPromise;
            if(pkg) renderChapter(pkg, true);
        });
    }

    // --- SERVERLESS API CALL ---
    async function callGemini(userText) {
        // Notice: No API Key in frontend
        const sys = `ROLE: Cyberpunk Sci-Fi Novel Generator. FORMAT: JSON ONLY. { "image_keyword": "Specific English Noun (e.g. gun, city)", "stage_1_env": "...", "stage_2_event": "...", "stage_3_analysis": "...", "is_game_over": boolean, "choices": [{"text": "A"}, {"text": "B"}] }`;
        
        // Gemini API requires history in a specific format { role: 'user'|'model', parts: [{ text: '...' }] }
        // Our backend expects { history, prompt }
        
        // Prepare history for backend
        const historyForBackend = [
            { role: "user", parts: [{ text: sys }] },
            ...history.slice(-4)
        ];

        const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                history: historyForBackend,
                prompt: userText 
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error);
        
        // Extract JSON from markdown block if present
        const cleanText = data.text.replace(/```json|```/g, "").trim();
        return JSON.parse(cleanText);
    }

    // --- REST OF THE LOGIC (Same as V10.1) ---
    async function fetchChapterData(userInput, isStart = false) {
        const prompt = isStart ? "GAME START. Generate first world." : `Player chose: "${userInput}". Continue.`;
        try {
            const json = await callGemini(prompt);
            if (isStart) {
                history.push({ role: "user", parts: [{text: "Start"}]});
                history.push({ role: "model", parts: [{text: JSON.stringify(json)}]});
            }
            const rawKw = json.image_keyword || "tech";
            const keyword = rawKw.split(' ')[0].replace(/[^a-zA-Z0-9]/g, "") || "scifi";
            const imgUrl = `https://loremflickr.com/640/360/cyberpunk,${keyword}?random=${Date.now()}`;
            const imgPromise = new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(imgUrl);
                img.onerror = () => resolve(imgUrl);
                setTimeout(() => resolve(imgUrl), 3000);
                img.src = imgUrl;
            });
            return { json, imgPromise };
        } catch (e) { console.error(e); alert("Connection Error"); return null; }
    }

    function renderChapter(pkg, silent=false) {
        const data = pkg.json; currentData = data; currentStage = 0;
        ['msg-1','msg-2','msg-3'].forEach(id=>{ document.getElementById(id).innerHTML=""; document.getElementById(id).classList.remove('show'); });
        document.getElementById('controls').classList.remove('active');
        document.getElementById('next-trigger').style.display='none';
        
        const imgEl = document.getElementById('scene-img'); imgEl.style.opacity=0;
        pkg.imgPromise.then(url => { imgEl.src=url; imgEl.onload=()=>{imgEl.style.opacity=0.8; document.getElementById('loading-hint').innerText="LIVE FEED";} });

        const m1 = document.getElementById('msg-1');
        if(silent) { m1.classList.add('show'); m1.innerHTML=data.stage_1_env; showNextTrigger(); triggerPreload(data.choices); }
        else { requestAnimationFrame(()=>m1.classList.add('show')); typeWriter(m1, data.stage_1_env, ()=>{ showNextTrigger(); triggerPreload(data.choices); }); }
    }

    function triggerPreload(choices) { preBuffer={A:null,B:null}; ['A','B'].forEach(async(k,i)=>{ try{preBuffer[k]=await fetchChapterData(choices[i].text);}catch(e){} }); }
    window.advanceFragment = function() {
        document.getElementById('next-trigger').style.display='none';
        if(currentStage===0) { currentStage=1; const el=document.getElementById('msg-2'); el.classList.add('show'); typeWriter(el, currentData.stage_2_event, showNextTrigger); }
        else if(currentStage===1) { currentStage=2; const el=document.getElementById('msg-3'); el.classList.add('show'); typeWriter(el, currentData.stage_3_analysis, ()=>{ 
            document.getElementById('btn-a').innerText=`[A] ${currentData.choices[0].text}`;
            document.getElementById('btn-b').innerText=`[B] ${currentData.choices[1].text}`;
            document.getElementById('controls').classList.add('active');
        }); }
    }
    window.makeChoice = async function(id) {
        const txt = currentData.choices[id==='A'?0:1].text;
        document.getElementById('controls').classList.remove('active');
        history.push({role:"user", parts:[{text:`Player chose: ${txt}`}]});
        const buf = preBuffer[id];
        if(buf) { history.push({role:"model",parts:[{text:JSON.stringify(buf.json)}]}); renderChapter(buf); }
        else { const d=await fetchChapterData(txt); renderChapter(d); }
    }
    function typeWriter(el,txt,cb) { let i=0; function t(){if(i<txt.length){el.innerHTML+=txt.charAt(i);i++;document.getElementById('content-scroll').scrollTop=9999;setTimeout(t,5);}else if(cb)cb();}t(); }
    function showNextTrigger(){document.getElementById('next-trigger').style.display='block';document.getElementById('content-scroll').scrollTop=9999;}
    
    // VISUALS
    function initParticles(){const c=document.getElementById('canvas-container');const s=new THREE.Scene();s.fog=new THREE.FogExp2(0,0.001);const cam=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1000);cam.position.z=100;const r=new THREE.WebGLRenderer({alpha:true});r.setSize(window.innerWidth,window.innerHeight);c.appendChild(r.domElement);const g=new THREE.BufferGeometry();const v=[],cl=[];for(let i=0;i<2000;i++){v.push((Math.random()-0.5)*400,(Math.random()-0.5)*400,(Math.random()-0.5)*400);const c=[0x00f3ff,0xbc13fe,0xff0055][Math.floor(Math.random()*3)];const hc=new THREE.Color(c);cl.push(hc.r,hc.g,hc.b);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));g.setAttribute('color',new THREE.Float32BufferAttribute(cl,3));const m=new THREE.PointsMaterial({size:3,vertexColors:true,opacity:0.6,transparent:true});const p=new THREE.Points(g,m);s.add(p);function ani(){requestAnimationFrame(ani);p.rotation.x+=0.0005;r.render(s,cam);}ani();}
    async function playIntroSequence(){const t=document.getElementById('intro-content');const d=document.getElementById('the-door');document.getElementById('intro-layer').style.display='flex';const l=["初始化...", "接入多元宇宙...", "同步完成"];for(let x of l){t.innerText=x;t.style.opacity=1;await new Promise(r=>setTimeout(r,1500));t.style.opacity=0;await new Promise(r=>setTimeout(r,500));}t.style.display='none';d.style.opacity=1;d.classList.add('zoom-effect');await new Promise(r=>setTimeout(r,2000));}
</script>
</body>
</html>